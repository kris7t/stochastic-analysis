\NeedsTeXFormat{LaTeX2e}[1994/06/01]
\ProvidesPackage{petriTikz}[2015/01/18 PetriTikZ]

\RequirePackage{array}
\RequirePackage{mathtools}
\RequirePackage{tikz}
\RequirePackage{xcolor}
\RequirePackage{xparse}

\DeclareOption{compactcap}{\petriCompactPlaceCapacities}
\DeclareOption{compactpi}{\petriCompactTransitionPriorities}
\DeclareOption{compactlambda}{\petriCompactTransitionRates}

\colorlet{petriDraw}{black}
\colorlet{petriFill}{white}
\newcommand*{\petriToken}{\bullet}

\tikzset{
  maybe at/.code={%
    \IfValueT{#1}{\tikzset{at={(#1)}}}%
  },
  conditional rotate/.code 2 args={%
    \IfBooleanT{#1}{\tikzset{rotate=#2}}%
  },
  above or left/.code 2 args={%
    \IfBooleanTF{#1}{\tikzset{left=#2}}{\tikzset{above=#2}}%
  },
  below or right/.code 2 args={%
    \IfBooleanTF{#1}{\tikzset{right=#2}}{\tikzset{below=#2}}%
  },
  conditional swap size/.style args={#1#2#3}{%
    minimum width=\IfBooleanTF{#1}{#3}{#2},
    minimum height=\IfBooleanTF{#1}{#2}{#3}
  },
  petri net place/.style={
    circle,
    draw=petriDraw,
    fill=petriFill,
    inner sep=0pt,
    minimum size=16pt
  },
  petri net transition/.style={
    rectangle,
    draw=petriDraw,
    fill=petriFill,
    inner sep=0pt,
    conditional swap size={#1}{6pt}{16pt}
  },
  petri net priority transition/.style={
    petri net transition,
    fill=petriDraw,
    conditional swap size={#1}{2pt}{16pt}
  },
  petri net label/.style={
    node distance=2pt,
    inner sep=2pt
  },
  petri net place name/.style 2 args={
    petri net label,
    above or left={#1}{of #2},
  },
  petri net place capacity/.style 2 args={
    petri net label,
    below or right={#1}{of #2},
  },
  petri net transition name/.style 2 args={
    petri net label,
    above or left={#1}{of #2},
  },
  petri net transition priority/.style 2 args={
    petri net label,
    below or right={#1}{of #2},
  },
}

\expandafter\newcommand\expandafter*\expandafter{\csname
  petri@Tokens0\endcsname}{}
\expandafter\newcommand\expandafter*\expandafter{\csname
  petri@Tokens1\endcsname}{\petriToken}
\expandafter\newcommand\expandafter*\expandafter{\csname
  petri@Tokens2\endcsname}{\petriToken\petriToken}
\expandafter\newcommand\expandafter*\expandafter{\csname
  petri@Tokens3\endcsname}{%
  \petriToken
  \mathclap{\raisebox{\dimexpr 1ex + 0.5pt}{$\petriToken$}}%
  \petriToken}
\expandafter\newcommand\expandafter*\expandafter{\csname
  petri@Tokens4\endcsname}{%
  \petriToken
  \mathclap{\raisebox{\dimexpr 1ex + 1pt}{$\petriToken \petriToken$}}%
  \petriToken}

\newcommand*{\petriPlaceNameLabel}[1]{#1}
\newcommand*{\petriPlaceCapacitySymbol}{c}
\newcommand*{\petriPlaceCapacityLabel}[1]{%
  $\petriPlaceCapacitySymbol = #1$}
\newcommand*{\petriTransitionNameLabel}[1]{#1}
\newcommand*{\petriTransitionPrioritySymbol}{\pi}
\newcommand*{\petriTransitionRateSymbol}{\lambda}
\newcommand*{\petriTransitionWeightSymbol}{w}
\newcommand*{\petriTransitionPriorityLabel}[1]{%
  $\petriTransitionPrioritySymbol = #1$}
\newcommand*{\petriTransitionRateLabel}[1]{%
  $\petriTransitionRateSymbol = #1$}
\newcommand*{\petriTransitionWeightLabel}[1]{%
  $\petriTransitionWeightSymbol = #1$}
\newcommand*{\petriTransitionPriorityWeightLabel}[2]{%
  $\begin{array}{r@{\;=\;}l}%
     \petriTransitionPrioritySymbol & #1 \\
     \petriTransitionWeightSymbol & #2%
   \end{array}$}
\newcommand*{\petriCompactPlaceCapacities}{%
  \renewcommand*{\petriPlaceCapacityLabel}[1]{$##1$}}
\newcommand*{\petriCompactTransitionPriorities}{%
  \renewcommand*{\petriTransitionWeightPriority}[1]{$##1$}}
\newcommand*{\petriCompactTransitionRates}{%
  \renewcommand*{\petriTransitionRateLabel}[1]{$##1$}%
  \renewcommand*{\petriTransitionWeightLabel}[1]{$##1$}}

\ProcessOptions\relax

\DeclareDocumentCommand{\petriP}{sr()O{}d()gD<>{0}g}{
  \node (#2) [petri net place,maybe at={#4},#3] {%
    \ifcsname petri@Tokens#6\endcsname
    $\csname petri@Tokens#6\endcsname$\else#6\fi};%
  \IfValueT{#5}{\node [petri net place name={#1}{#2}] {%
      \petriPlaceNameLabel{#5}};}%
  \IfValueT{#7}{\node [petri net place capacity={#1}{#2}] {%
    \petriPlaceCapacityLabel{#7}};}%
}

\DeclareDocumentCommand{\petriT}{sr()O{}d()gD<>{0}g}{
  \node (#2) [\ifnum#6>0petri net priority transition\else petri net
  transition\fi={#1},maybe at={#4},#3] {};
  \IfValueT{#5}{\node [petri net transition name={#1}{#2}] {%
    \petriTransitionNameLabel{#5}};}%
  \ifnum#6=0%
    \IfValueT{#7}{\node [petri net transition priority={#1}{#2}] {%
        \petriTransitionRateLabel{#7}};}%
  \else
    \ifnum#6=1%
      \IfValueT{#7}{\node [petri net transition priority={#1}{#2}] {%
        \petriTransitionWeightLabel{#7}};}%
    \else
      \node [petri net transition priority={#1}{#2}] {%
        \IfValueTF{#7}{%
          \petriTransitionPriorityWeightLabel{#6}{#7}}{%
          \petriTransitionPriorityLabel{#6}}};%
    \fi
  \fi
}